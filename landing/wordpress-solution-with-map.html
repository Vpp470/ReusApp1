<!-- 
=================================================================
SOLUCI√ì WORDPRESS AMB MAPA PER ELTOMBDEREUS.COM
=================================================================

INSTRUCCIONS:
1. Aneu a WordPress Admin
2. Settings > Insert Headers and Footers
3. SUBSTITUEIX tot el codi anterior al camp "Scripts in Footer"
4. Enganxa aquest codi complet
5. Desa els canvis

=================================================================
-->

<!-- Leaflet CSS per al mapa -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- META TAGS ANTI-CACH√â -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<!-- ESTILS -->
<style>
.tomb-map-section {
    padding: 60px 20px;
    background: #ffffff;
}

.tomb-establishments-section {
    padding: 60px 20px;
    background: #f8f9fa;
}

.tomb-container {
    max-width: 1200px;
    margin: 0 auto;
}

.tomb-section-title {
    text-align: center;
    font-size: 2.5rem;
    margin-bottom: 20px;
    color: #2c3e50;
}

.tomb-section-subtitle {
    text-align: center;
    font-size: 1.2rem;
    color: #7f8c8d;
    margin-bottom: 40px;
}

/* Mapa */
.tomb-map-container {
    width: 100%;
    height: 500px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-bottom: 40px;
    overflow: hidden;
}

/* Estad√≠stiques */
.tomb-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.tomb-stat-card {
    background: white;
    padding: 30px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.tomb-stat-number {
    font-size: 3rem;
    font-weight: bold;
    color: #e74c3c;
    margin-bottom: 10px;
}

.tomb-stat-label {
    font-size: 1rem;
    color: #7f8c8d;
}

/* Graella d'establiments */
.tomb-establishments-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 24px;
    margin-top: 40px;
}

.tomb-establishment-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    cursor: pointer;
}

.tomb-establishment-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.tomb-establishment-img {
    width: 100%;
    height: 200px;
    object-fit: cover;
}

.tomb-establishment-content {
    padding: 20px;
}

.tomb-establishment-name {
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 8px;
    color: #2c3e50;
}

.tomb-establishment-category {
    color: #7f8c8d;
    font-size: 0.9rem;
    margin-bottom: 12px;
}

.tomb-establishment-address {
    font-size: 0.9rem;
    color: #555;
    margin: 8px 0;
}

.tomb-establishment-phone {
    font-size: 0.9rem;
    color: #555;
    margin: 8px 0;
}

.tomb-loading {
    text-align: center;
    padding: 40px;
    font-size: 1.2rem;
    color: #7f8c8d;
}

/* Popup del mapa */
.leaflet-popup-content-wrapper {
    border-radius: 8px;
}

.tomb-popup-content h3 {
    margin: 0 0 8px 0;
    color: #2c3e50;
    font-size: 1.1rem;
}

.tomb-popup-content p {
    margin: 4px 0;
    font-size: 0.9rem;
    color: #555;
}

/* Responsive */
@media (max-width: 768px) {
    .tomb-section-title {
        font-size: 2rem;
    }
    
    .tomb-map-container {
        height: 400px;
    }
    
    .tomb-establishments-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<!-- SECCI√ì DEL MAPA -->
<div class="tomb-map-section">
    <div class="tomb-container">
        <h2 class="tomb-section-title">Troba els Nostres Establiments</h2>
        <p class="tomb-section-subtitle">Tots els comer√ßos geolocalitzats al mapa de Reus</p>
        
        <!-- Mapa -->
        <div id="tomb-map" class="tomb-map-container"></div>
        
        <!-- Estad√≠stiques -->
        <div class="tomb-stats">
            <div class="tomb-stat-card">
                <div class="tomb-stat-number" id="tomb-total-establishments">0</div>
                <div class="tomb-stat-label">Establiments</div>
            </div>
            <div class="tomb-stat-card">
                <div class="tomb-stat-number" id="tomb-total-offers">0</div>
                <div class="tomb-stat-label">Ofertes Actives</div>
            </div>
            <div class="tomb-stat-card">
                <div class="tomb-stat-number" id="tomb-total-events">0</div>
                <div class="tomb-stat-label">Esdeveniments</div>
            </div>
        </div>
    </div>
</div>

<!-- SECCI√ì D'ESTABLIMENTS -->
<div class="tomb-establishments-section">
    <div class="tomb-container">
        <h2 class="tomb-section-title">Els Nostres Establiments</h2>
        <p class="tomb-section-subtitle">Descobreix el comer√ß local de Reus</p>
        
        <!-- Grid d'Establiments -->
        <div id="tomb-establishments-grid" class="tomb-establishments-grid">
            <p class="tomb-loading">Carregant establiments...</p>
        </div>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- JAVASCRIPT -->
<script>
(function() {
    'use strict';
    
    const API_BASE_URL = 'https://reusapp-backend-production.up.railway.app/api';
    const CACHE_BUSTER = '?t=' + new Date().getTime();
    
    let map = null;
    let markers = [];
    
    console.log('üöÄ Carregant dades des de l\'API de Railway...');
    
    // Inicialitzar el mapa
    function initMap() {
        // Coordenades de Reus
        const reusCoords = [41.1553, 1.1074];
        
        // Crear el mapa
        map = L.map('tomb-map').setView(reusCoords, 14);
        
        // Afegir capa de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        console.log('‚úÖ Mapa inicialitzat');
    }
    
    // Afegir marcadors al mapa
    function addMarkersToMap(establishments) {
        // Netejar marcadors antics
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];
        
        establishments.forEach(est => {
            // Nom√©s afegir si t√© coordenades
            if (est.latitude && est.longitude) {
                const marker = L.marker([est.latitude, est.longitude])
                    .addTo(map)
                    .bindPopup(`
                        <div class="tomb-popup-content">
                            <h3>${est.name}</h3>
                            ${est.category ? `<p><strong>Categoria:</strong> ${est.category}</p>` : ''}
                            ${est.address ? `<p>üìç ${est.address}</p>` : ''}
                            ${est.phone ? `<p>üìû ${est.phone}</p>` : ''}
                        </div>
                    `);
                
                markers.push(marker);
            }
        });
        
        console.log(`‚úÖ Afegits ${markers.length} marcadors al mapa`);
    }
    
    // Carregar establiments
    async function loadEstablishments() {
        try {
            const response = await fetch(API_BASE_URL + '/establishments' + CACHE_BUSTER, {
                method: 'GET',
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            });
            
            if (!response.ok) {
                throw new Error('Error carregant establiments');
            }
            
            const establishments = await response.json();
            console.log('‚úÖ Carregats ' + establishments.length + ' establiments');
            
            // Afegir marcadors al mapa
            addMarkersToMap(establishments);
            
            // Renderitzar graella
            renderEstablishments(establishments);
            
            // Actualitzar estad√≠stiques
            document.getElementById('tomb-total-establishments').textContent = establishments.length;
            
        } catch (error) {
            console.error('‚ùå Error:', error);
            document.getElementById('tomb-establishments-grid').innerHTML = 
                '<p class="tomb-loading">Error carregant establiments. Si us plau, refresca la p√†gina.</p>';
        }
    }
    
    // Carregar ofertes (nom√©s per comptar)
    async function loadOffers() {
        try {
            const response = await fetch(API_BASE_URL + '/offers' + CACHE_BUSTER, {
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            });
            
            if (!response.ok) throw new Error('Error carregant ofertes');
            
            const offers = await response.json();
            const now = new Date();
            const activeOffers = offers.filter(offer => {
                const validUntil = new Date(offer.valid_until);
                return now <= validUntil;
            });
            
            document.getElementById('tomb-total-offers').textContent = activeOffers.length;
            console.log('‚úÖ Ofertes actives: ' + activeOffers.length);
            
        } catch (error) {
            console.error('‚ùå Error carregant ofertes:', error);
        }
    }
    
    // Carregar esdeveniments (nom√©s per comptar)
    async function loadEvents() {
        try {
            const response = await fetch(API_BASE_URL + '/events' + CACHE_BUSTER, {
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            });
            
            if (!response.ok) throw new Error('Error carregant esdeveniments');
            
            const events = await response.json();
            const now = new Date();
            const activeEvents = events.filter(event => {
                const validUntil = new Date(event.valid_until);
                return now <= validUntil;
            });
            
            document.getElementById('tomb-total-events').textContent = activeEvents.length;
            console.log('‚úÖ Esdeveniments actius: ' + activeEvents.length);
            
        } catch (error) {
            console.error('‚ùå Error carregant esdeveniments:', error);
        }
    }
    
    // Renderitzar establiments
    function renderEstablishments(establishments) {
        const grid = document.getElementById('tomb-establishments-grid');
        
        if (!establishments || establishments.length === 0) {
            grid.innerHTML = '<p class="tomb-loading">No hi ha establiments disponibles.</p>';
            return;
        }
        
        // Limitar a 12 establiments
        const limitedEstablishments = establishments.slice(0, 12);
        
        grid.innerHTML = limitedEstablishments.map(est => {
            const imageUrl = est.logo_url || est.image_url || 'https://via.placeholder.com/300x200?text=Sense+imatge';
            
            return `
                <div class="tomb-establishment-card">
                    <img 
                        src="${imageUrl}" 
                        alt="${est.name}"
                        class="tomb-establishment-img"
                        onerror="this.src='https://via.placeholder.com/300x200?text=Sense+imatge'"
                    >
                    <div class="tomb-establishment-content">
                        <h3 class="tomb-establishment-name">${est.name}</h3>
                        ${est.category ? `<p class="tomb-establishment-category">${est.category}</p>` : ''}
                        ${est.address ? `<p class="tomb-establishment-address">üìç ${est.address}</p>` : ''}
                        ${est.phone ? `<p class="tomb-establishment-phone">üìû ${est.phone}</p>` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Iniciar quan el DOM estigui llest
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadEstablishments();
            loadOffers();
            loadEvents();
        });
    } else {
        initMap();
        loadEstablishments();
        loadOffers();
        loadEvents();
    }
    
    console.log('‚úÖ Script El Tomb de Reus amb mapa carregat correctament');
    
})();
</script>
