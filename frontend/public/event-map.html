<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { 
      margin: 0; 
      padding: 0; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    #map { width: 100%; height: 100vh; }
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 1000;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    <p>Carregant mapa...</p>
  </div>
  <div id="map"></div>
  <script>
    // Obtenir l'ID de l'esdeveniment des de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('eventId');
    
    if (!eventId) {
      document.getElementById('loading').innerHTML = '<p style="color: red;">Error: No s\'ha especificat l\'ID de l\'esdeveniment</p>';
    } else {
      // Obtenir l'origen (protocol + host + port) del document actual
      const baseUrl = window.location.origin;
      console.log('Base URL:', baseUrl);
      
      // Carregar dades de l'esdeveniment i establiments
      Promise.all([
        fetch(`${baseUrl}/api/events/${eventId}`).then(r => r.json()),
        fetch(`${baseUrl}/api/establishments`).then(r => r.json())
      ])
      .then(([event, allEstablishments]) => {
        document.getElementById('loading').style.display = 'none';
        
        console.log('=== DEBUG EVENT MAP ===');
        console.log('Event:', event);
        console.log('Participant IDs from event.participating_establishment_ids:', event.participating_establishment_ids);
        console.log('Participant IDs from event.participating_establishments:', event.participating_establishments);
        console.log('Total establishments fetched:', allEstablishments.length);
        
        // Utilitzar només participating_establishment_ids (el camp correcte)
        const participantIds = event.participating_establishment_ids || [];
        
        // Convertir tots els IDs a string per comparació
        const participantIdsStr = participantIds.map(id => String(id));
        
        console.log('Using participant IDs (as strings):', participantIdsStr);
        
        // Sample of establishment IDs for debugging
        console.log('Sample establishment IDs:', allEstablishments.slice(0, 3).map(e => ({ name: e.name, _id: e._id, id: e.id })));
        
        const participants = allEstablishments.filter(est => {
          const estIdStr = String(est._id || est.id);
          const isParticipant = participantIdsStr.includes(estIdStr);
          if (isParticipant) {
            console.log('✓ Matched participant:', est.name, 'ID:', estIdStr);
          }
          return isParticipant;
        }).filter(est => est.latitude && est.longitude);
        
        console.log('=== RESULTS ===');
        console.log('Final participants with coordinates:', participants.length);
        console.log('Participants:', participants.map(p => ({ name: p.name, id: p._id || p.id })));
        
        if (participants.length === 0) {
          document.getElementById('map').innerHTML = 
            '<div style="padding: 20px; text-align: center; color: #666;">' +
            '<p>No hi ha establiments amb coordenades per mostrar al mapa.</p>' +
            '</div>';
          return;
        }
        
        // Calcular el centre del mapa (mitjana de coordenades)
        const centerLat = participants.reduce((sum, p) => sum + p.latitude, 0) / participants.length;
        const centerLng = participants.reduce((sum, p) => sum + p.longitude, 0) / participants.length;
        
        // Crear mapa
        const map = L.map('map').setView([centerLat, centerLng], 14);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors',
          maxZoom: 19
        }).addTo(map);

        // Icona verda per establiments participants
        const greenIcon = L.icon({
          iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNSIgaGVpZ2h0PSI0MSIgdmlld0JveD0iMCAwIDI1IDQxIj48cGF0aCBmaWxsPSIjMDBDRDUzIiBkPSJNMTIuNSAwQzUuNiAwIDAgNS42IDAgMTIuNWMwIDEuNCAwLjIgMi44IDAuNyA0LjFMOC4zIDM1bC0wLjEgMC4xQzkuNCAzNy4xIDEwLjkgMzkgMTIuNSA0MWMxLjYtMiAzLjEtMy45IDQuMy02bC0wLjEtMC4xTDI0LjMgMTYuNmMwLjUtMS4zIDAuNy0yLjcgMC43LTQuMUMyNSA1LjYgMTkuNCAwIDEyLjUgMHpNMTIuNSAxN2MtMi41IDAtNC41LTItNC41LTQuNXMyLTQuNSA0LjUtNC41IDQuNSAyIDQuNSA0LjVTMTUgMTcgMTIuNSAxN3oiLz48L3N2Zz4=',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34]
        });

        // Afegir marcadors dels participants
        participants.forEach(participant => {
          const marker = L.marker([participant.latitude, participant.longitude], { icon: greenIcon })
            .addTo(map)
            .bindPopup(`
              <div style="min-width: 200px;">
                <h3 style="margin: 0 0 8px 0; font-size: 16px; color: #333;">${participant.name}</h3>
                ${participant.category ? `<p style="margin: 4px 0; color: #00CD53; font-weight: 600;">✓ Participant</p>` : ''}
                ${participant.address ? `<p style="margin: 4px 0; color: #666; font-size: 14px;">${participant.address}</p>` : ''}
                <div style="margin-top: 12px; display: flex; gap: 8px;">
                  <a href="/establishments/${participant.id || participant._id}" 
                     style="flex: 1; padding: 8px; background: #00CD53; color: white; text-decoration: none; border-radius: 8px; text-align: center; font-size: 14px;">
                    Veure Perfil
                  </a>
                  <a href="https://www.google.com/maps/search/?api=1&query=${participant.latitude},${participant.longitude}" 
                     target="_blank"
                     style="flex: 1; padding: 8px; background: #007AFF; color: white; text-decoration: none; border-radius: 8px; text-align: center; font-size: 14px;">
                    Google Maps
                  </a>
                </div>
              </div>
            `);
        });
        
        // Ajustar el zoom per mostrar tots els marcadors
        if (participants.length > 1) {
          const bounds = L.latLngBounds(participants.map(p => [p.latitude, p.longitude]));
          map.fitBounds(bounds, { padding: [50, 50] });
        }
        
        // Obtenir ubicació de l'usuari
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const userLat = position.coords.latitude;
              const userLng = position.coords.longitude;
              
              // Icona vermella per usuari
              const redIcon = L.icon({
                iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNSIgaGVpZ2h0PSI0MSIgdmlld0JveD0iMCAwIDI1IDQxIj48cGF0aCBmaWxsPSIjRkYwMDAwIiBkPSJNMTIuNSAwQzUuNiAwIDAgNS42IDAgMTIuNWMwIDEuNCAwLjIgMi44IDAuNyA0LjFMOC4zIDM1bC0wLjEgMC4xQzkuNCAzNy4xIDEwLjkgMzkgMTIuNSA0MWMxLjYtMiAzLjEtMy45IDQuMy02bC0wLjEtMC4xTDI0LjMgMTYuNmMwLjUtMS4zIDAuNy0yLjcgMC43LTQuMUMyNSA1LjYgMTkuNCAwIDEyLjUgMHpNMTIuNSAxN2MtMi41IDAtNC41LTItNC41LTQuNXMyLTQuNSA0LjUtNC41IDQuNSAyIDQuNSA0LjVTMTUgMTcgMTIuNSAxN3oiLz48L3N2Zz4=',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34]
              });
              
              L.marker([userLat, userLng], { icon: redIcon })
                .addTo(map)
                .bindPopup('<strong>La teva posició</strong>');
            }
          );
        }
      })
      .catch(error => {
        console.error('Error carregant dades:', error);
        document.getElementById('loading').innerHTML = 
          '<p style="color: red;">Error carregant les dades. Si us plau, refresca la pàgina.</p>';
      });
    }
  </script>
</body>
</html>
