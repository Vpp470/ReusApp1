<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { margin: 0; padding: 0; }
    #map { width: 100%; height: 100vh; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    // Obtenir dades dels establiments
    fetch('/api/establishments')
      .then(response => response.json())
      .then(data => {
        const establishments = data.filter(est => est.latitude && est.longitude);
        
        // Crear mapa centrat a Reus
        const map = L.map('map').setView([41.1557, 1.1072], 14);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors',
          maxZoom: 19
        }).addTo(map);

        // Icona blava per establiments
        const blueIcon = L.icon({
          iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNSIgaGVpZ2h0PSI0MSIgdmlld0JveD0iMCAwIDI1IDQxIj48cGF0aCBmaWxsPSIjMDA3QUZGIiBkPSJNMTIuNSAwQzUuNiAwIDAgNS42IDAgMTIuNWMwIDEuNCAwLjIgMi44IDAuNyA0LjFMOC4zIDM1bC0wLjEgMC4xQzkuNCAzNy4xIDEwLjkgMzkgMTIuNSA0MWMxLjYtMiAzLjEtMy45IDQuMy02bC0wLjEtMC4xTDI0LjMgMTYuNmMwLjUtMS4zIDAuNy0yLjcgMC43LTQuMUMyNSA1LjYgMTkuNCAwIDEyLjUgMHpNMTIuNSAxN2MtMi41IDAtNC41LTItNC41LTQuNXMyLTQuNSA0LjUtNC41IDQuNSAyIDQuNSA0LjVTMTUgMTcgMTIuNSAxN3oiLz48L3N2Zz4=',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34]
        });

        // Afegir marcadors d'establiments
        establishments.forEach(est => {
          L.marker([est.latitude, est.longitude], { icon: blueIcon })
            .addTo(map)
            .bindPopup(`
              <div style="min-width: 200px;">
                <h3 style="margin: 0 0 8px 0; font-size: 16px; color: #333;">${est.name}</h3>
                ${est.category ? `<p style="margin: 4px 0; color: #007AFF; font-weight: 600;">${est.category}</p>` : ''}
                ${est.address ? `<p style="margin: 4px 0; color: #666; font-size: 14px;">${est.address}</p>` : ''}
                <a href="/establishments/${est.id}" style="display: block; margin-top: 8px; padding: 8px 16px; background: #007AFF; color: white; text-decoration: none; border-radius: 8px; text-align: center;">
                  Veure detalls
                </a>
              </div>
            `);
        });

        // Intentar obtenir ubicació de l'usuari
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const userLat = position.coords.latitude;
              const userLng = position.coords.longitude;
              
              // Icona vermella per usuari
              const redIcon = L.icon({
                iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNSIgaGVpZ2h0PSI0MSIgdmlld0JveD0iMCAwIDI1IDQxIj48cGF0aCBmaWxsPSIjRkYwMDAwIiBkPSJNMTIuNSAwQzUuNiAwIDAgNS42IDAgMTIuNWMwIDEuNCAwLjIgMi44IDAuNyA0LjFMOC4zIDM1bC0wLjEgMC4xQzkuNCAzNy4xIDEwLjkgMzkgMTIuNSA0MWMxLjYtMiAzLjEtMy45IDQuMy02bC0wLjEtMC4xTDI0LjMgMTYuNmMwLjUtMS4zIDAuNy0yLjcgMC43LTQuMUMyNSA1LjYgMTkuNCAwIDEyLjUgMHpNMTIuNSAxN2MtMi41IDAtNC41LTItNC41LTQuNXMyLTQuNSA0LjUtNC41IDQuNSAyIDQuNSA0LjVTMTUgMTcgMTIuNSAxN3oiLz48L3N2Zz4=',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34]
              });
              
              L.marker([userLat, userLng], { icon: redIcon })
                .addTo(map)
                .bindPopup('<strong>La teva posició</strong>');
              
              // Centrar mapa a la ubicació de l'usuari
              map.setView([userLat, userLng], 15);
            },
            (error) => {
              console.log('No s\'ha pogut obtenir la ubicació:', error);
            }
          );
        }
      })
      .catch(error => {
        console.error('Error carregant establiments:', error);
        document.getElementById('map').innerHTML = 
          '<div style="padding: 20px; text-align: center; color: #666;">Error carregant el mapa. Si us plau, refresca la pàgina.</div>';
      });
  </script>
</body>
</html>
