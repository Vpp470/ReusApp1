import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  ScrollView,
  TouchableOpacity,
  Pressable,
  TextInput,
  Alert,
  ActivityIndicator,
  Modal,
} from 'react-native';
import { useRouter } from 'expo-router';
import { MaterialIcons } from '@expo/vector-icons';
import { SafeAreaView } from 'react-native-safe-area-context';
import Constants from 'expo-constants';
import { Colors, Spacing, BorderRadius, FontSizes } from '../../src/constants/colors';
import { useAuthStore } from '../../src/store/authStore';
import { adminService } from '../../src/services/api';
import api from '../../src/services/api';
import type { User } from '../../src/types';

export default function AdminUsers() {
  const router = useRouter();
  const { token, user: currentUser } = useAuthStore();
  const [users, setUsers] = useState<User[]>([]);
  const [filteredUsers, setFilteredUsers] = useState<User[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState('');
  const [modalVisible, setModalVisible] = useState(false);
  const [selectedUser, setSelectedUser] = useState<User | null>(null);
  const [selectedRole, setSelectedRole] = useState<'user' | 'admin' | 'local_associat' | 'entitat_colaboradora' | 'membre_consell'>('user');
  
  // Estats per assignar establiment
  const [establishments, setEstablishments] = useState<any[]>([]);
  const [filteredEstablishments, setFilteredEstablishments] = useState<any[]>([]);
  const [establishmentSearchQuery, setEstablishmentSearchQuery] = useState('');
  const [selectedEstablishmentId, setSelectedEstablishmentId] = useState<string>('');
  const [currentEstablishment, setCurrentEstablishment] = useState<any>(null);
  const [loadingEstablishment, setLoadingEstablishment] = useState(false);
  const [showEstablishmentPicker, setShowEstablishmentPicker] = useState(false);

  useEffect(() => {
    loadUsers();
  }, []);

  useEffect(() => {
    // Filtrar usuaris segons cerca
    if (searchQuery.trim() === '') {
      setFilteredUsers(users);
    } else {
      const filtered = users.filter(
        (user) =>
          user.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
          user.email.toLowerCase().includes(searchQuery.toLowerCase())
      );
      setFilteredUsers(filtered);
    }
  }, [searchQuery, users]);

  const loadUsers = async () => {
    try {
      setLoading(true);
      const data = await adminService.users.getAll(token!);
      setUsers(data);
      setFilteredUsers(data);
    } catch (error) {
      Alert.alert('Error', 'No s\'han pogut carregar els usuaris');
    } finally {
      setLoading(false);
    }
  };

  const handleChangeRole = (user: User) => {
    if (user.email === currentUser?.email) {
      Alert.alert(
        'Acci贸 no permesa',
        'No pots canviar el teu propi rol'
      );
      return;
    }

    setSelectedUser(user);
    setSelectedRole(user.role || 'user');
    setModalVisible(true);
    
    // Carregar establiments si 茅s local associat
    if (user.role === 'local_associat' || true) {
      loadEstablishments();
    }
  };

  const handleSaveRole = async () => {
    if (!selectedUser) return;

    try {
      console.log('Saving role for user:', selectedUser.email, 'New role:', selectedRole);
      await adminService.users.update(token!, selectedUser.id, {
        role: selectedRole,
      });

      console.log('Role updated successfully');
      setModalVisible(false);
      loadUsers();
    } catch (error: any) {
      console.error('Error updating role:', error);
      console.error('Error details:', error.response?.data);
    }
  };


  const loadEstablishments = async () => {
    try {
      const response = await api.get('/establishments');
      setEstablishments(response.data);
      setFilteredEstablishments(response.data); // Inicialitzar la llista filtrada
    } catch (error) {
      console.error('Error loading establishments:', error);
    }
  };

  // Efecte per filtrar establiments segons la cerca
  useEffect(() => {
    if (establishmentSearchQuery.trim() === '') {
      setFilteredEstablishments(establishments);
    } else {
      const filtered = establishments.filter((est) =>
        est.name.toLowerCase().includes(establishmentSearchQuery.toLowerCase())
      );
      setFilteredEstablishments(filtered);
    }
  }, [establishmentSearchQuery, establishments]);

  const loadUserEstablishment = async (userEmail: string) => {
    try {
      setLoadingEstablishment(true);
      // Buscar si aquest usuari t茅 algun establiment assignat
      const allEstablishments = await api.get('/establishments');
      const userEstablishment = allEstablishments.data.find((est: any) => {
        // Necesitem comparar owner_id amb user._id, per貌 aix貌 requereix una cerca m茅s elaborada
        // Per ara, nom茅s carreguem tots els establiments
        return false;
      });
      setCurrentEstablishment(userEstablishment);
    } catch (error) {
      console.error('Error loading user establishment:', error);
    } finally {
      setLoadingEstablishment(false);
    }
  };

  const handleAssignEstablishment = async () => {
    if (!selectedUser || !selectedEstablishmentId) {
      Alert.alert('Error', 'Si us plau, selecciona un establiment');
      return;
    }

    try {
      setLoadingEstablishment(true);
      
      // Utilitzar api.post amb parmetres de query
      const response = await api.post(
        `/admin/establishments/${selectedEstablishmentId}/assign-owner`,
        {},
        {
          params: {
            owner_email: selectedUser.email
          },
          headers: {
            'Authorization': token || '',
          },
        }
      );

      Alert.alert('xit', response.data.message || 'Establiment assignat correctament');
      setShowEstablishmentPicker(false);
      setSelectedEstablishmentId('');
      
      // Recarregar usuaris per actualitzar la vista
      loadUsers();
    } catch (error: any) {
      console.error('Error assigning establishment:', error);
      const errorMsg = error.response?.data?.detail || error.message || 'No s\'ha pogut assignar l\'establiment';
      Alert.alert('Error', errorMsg);
    } finally {
      setLoadingEstablishment(false);
    }
  };


  const getRoleBadgeStyle = (role?: string) => {
    switch (role) {
      case 'admin':
        return {
          backgroundColor: Colors.error + '20',
          color: Colors.error,
        };
      case 'local_associat':
        return {
          backgroundColor: Colors.accent + '20',
          color: Colors.accent,
        };
      case 'entitat_colaboradora':
        return {
          backgroundColor: Colors.primary + '20',
          color: Colors.primary,
        };
      case 'membre_consell':
        return {
          backgroundColor: '#9C27B0' + '20', // Morat
          color: '#9C27B0',
        };
      default:
        return {
          backgroundColor: Colors.success + '20',
          color: Colors.success,
        };
    }
  };

  const getRoleLabel = (role?: string) => {
    switch (role) {
      case 'admin':
        return 'Admin';
      case 'local_associat':
        return 'Local Associat';
      case 'entitat_colaboradora':
        return 'Entitat Col路laboradora';
      case 'membre_consell':
        return 'Membre del Consell';
      default:
        return 'Usuari';
    }
  };

  const handleDeleteUser = (user: User) => {
    if (user.email === currentUser?.email) {
      Alert.alert(
        'Acci贸 no permesa',
        'No pots eliminar el teu propi compte'
      );
      return;
    }

    Alert.alert(
      'Confirmar eliminaci贸',
      `Ests segur que vols eliminar l'usuari ${user.name}? Aquesta acci贸 no es pot desfer.`,
      [
        {
          text: 'Cancel路lar',
          style: 'cancel',
        },
        {
          text: 'Eliminar',
          style: 'destructive',
          onPress: async () => {
            try {
              await adminService.users.delete(token!, user.id);
              Alert.alert('xit', 'Usuari eliminat correctament');
              loadUsers();
            } catch (error: any) {
              Alert.alert('Error', error.response?.data?.detail || 'No s\'ha pogut eliminar l\'usuari');
            }
          },
        },
      ]
    );
  };

  if (loading) {
    return (
      <SafeAreaView style={styles.container} edges={['top']}>
        <View style={[styles.container, styles.centered]}>
          <ActivityIndicator size="large" color={Colors.primary} />
        </View>
      </SafeAreaView>
    );
  }

  return (
    <SafeAreaView style={styles.container} edges={['top']}>
      <View style={styles.header}>
        <TouchableOpacity onPress={() => router.back()} style={styles.backButton}>
          <MaterialIcons name="arrow-back" size={24} color={Colors.white} />
        </TouchableOpacity>
        <Text style={styles.headerTitle}>Gesti贸 d'Usuaris</Text>
        <View style={styles.placeholder} />
      </View>

      {/* Search bar */}
      <View style={styles.searchContainer}>
        <MaterialIcons name="search" size={24} color={Colors.gray} />
        <TextInput
          style={styles.searchInput}
          placeholder="Buscar per nom o email..."
          value={searchQuery}
          onChangeText={setSearchQuery}
        />
        {searchQuery.length > 0 && (
          <TouchableOpacity onPress={() => setSearchQuery('')}>
            <MaterialIcons name="close" size={24} color={Colors.gray} />
          </TouchableOpacity>
        )}
      </View>

      {/* Stats */}
      <ScrollView horizontal showsHorizontalScrollIndicator={false} style={styles.statsScrollView}>
        <View style={styles.statsContainer}>
          <View style={styles.statCard}>
            <Text style={styles.statNumber}>{users.length}</Text>
            <Text style={styles.statLabel}>Total</Text>
          </View>
          <View style={styles.statCard}>
            <Text style={styles.statNumber}>
              {users.filter((u) => u.role === 'admin').length}
            </Text>
            <Text style={styles.statLabel}>Admins</Text>
          </View>
          <View style={styles.statCard}>
            <Text style={styles.statNumber}>
              {users.filter((u) => u.role === 'membre_consell').length}
            </Text>
            <Text style={styles.statLabel}>Consell</Text>
          </View>
          <View style={styles.statCard}>
            <Text style={styles.statNumber}>
              {users.filter((u) => u.role === 'local_associat').length}
            </Text>
            <Text style={styles.statLabel}>Locals</Text>
          </View>
          <View style={styles.statCard}>
            <Text style={styles.statNumber}>
              {users.filter((u) => u.role === 'entitat_colaboradora').length}
            </Text>
            <Text style={styles.statLabel}>Entitats</Text>
          </View>
          <View style={styles.statCard}>
            <Text style={styles.statNumber}>
              {users.filter((u) => !u.role || u.role === 'user').length}
            </Text>
            <Text style={styles.statLabel}>Usuaris</Text>
          </View>
        </View>
      </ScrollView>

      <ScrollView 
        style={styles.content}
        contentContainerStyle={styles.contentContainer}
        showsVerticalScrollIndicator={true}
      >
        {filteredUsers.length === 0 ? (
          <View style={styles.emptyState}>
            <MaterialIcons name="person-off" size={80} color={Colors.lightGray} />
            <Text style={styles.emptyText}>
              {searchQuery ? 'No s\'han trobat usuaris' : 'No hi ha usuaris'}
            </Text>
          </View>
        ) : (
          filteredUsers.map((user, index) => (
            <View key={user.id || `user-${index}`} style={styles.card}>
              {/* Informaci贸 d'usuari */}
              <View style={styles.userRow}>
                <View style={styles.avatarCircle}>
                  <MaterialIcons
                    name="person"
                    size={30}
                    color={Colors.white}
                  />
                </View>
                <View style={styles.userDetails}>
                  <Text style={styles.userName}>{user.name}</Text>
                  <Text style={styles.userEmail}>{user.email}</Text>
                  <View
                    style={[
                      styles.roleTag,
                      { backgroundColor: getRoleBadgeStyle(user.role).backgroundColor },
                    ]}
                  >
                    <Text style={[styles.roleTagText, { color: getRoleBadgeStyle(user.role).color }]}>
                      {getRoleLabel(user.role)}
                    </Text>
                  </View>
                </View>
              </View>

              {/* Botons grans i clars */}
              {user.email === currentUser?.email ? (
                // Si 茅s l'usuari actual, mostrar badge especial
                <View style={styles.currentUserInfo}>
                  <MaterialIcons name="stars" size={24} color={Colors.accent} />
                  <Text style={styles.currentUserText}>Aquest 茅s el teu compte</Text>
                </View>
              ) : (
                // Si 茅s un altre usuari, mostrar botons d'edici贸
                <View style={styles.buttonRow}>
                  <TouchableOpacity
                    style={styles.editButton}
                    onPress={() => handleChangeRole(user)}
                    activeOpacity={0.7}
                  >
                    <MaterialIcons name="edit" size={24} color={Colors.white} />
                    <Text style={styles.editButtonText}>EDITAR ROL</Text>
                  </TouchableOpacity>
                  
                  <TouchableOpacity
                    style={styles.deleteButtonNew}
                    onPress={() => handleDeleteUser(user)}
                    activeOpacity={0.7}
                  >
                    <MaterialIcons name="delete" size={24} color={Colors.white} />
                  </TouchableOpacity>
                </View>
              )}
            </View>
          ))
        )}
      </ScrollView>

      {/* Modal for role change */}
      <Modal
        visible={modalVisible}
        animationType="slide"
        transparent={true}
        onRequestClose={() => setModalVisible(false)}
      >
        <View style={styles.modalContainer}>
          <View style={styles.modalContent}>
            <View style={styles.modalHeader}>
              <Text style={styles.modalTitle}>Canviar Rol d'Usuari</Text>
              <TouchableOpacity onPress={() => setModalVisible(false)}>
                <MaterialIcons name="close" size={24} color={Colors.text} />
              </TouchableOpacity>
            </View>

            <ScrollView style={styles.modalBody} showsVerticalScrollIndicator={true}>
              <Text style={styles.modalUserName}>{selectedUser?.name}</Text>
              <Text style={styles.modalUserEmail}>{selectedUser?.email}</Text>

              <Text style={styles.label}>Selecciona el nou rol:</Text>

              <TouchableOpacity
                style={[
                  styles.roleOption,
                  selectedRole === 'user' && styles.roleOptionSelected,
                ]}
                onPress={() => setSelectedRole('user')}
              >
                <MaterialIcons
                  name="person"
                  size={24}
                  color={selectedRole === 'user' ? Colors.success : Colors.gray}
                />
                <View style={styles.roleOptionInfo}>
                  <Text
                    style={[
                      styles.roleOptionTitle,
                      selectedRole === 'user' && styles.roleOptionTitleSelected,
                    ]}
                  >
                    Usuari
                  </Text>
                  <Text style={styles.roleOptionDescription}>
                    Acc茅s normal a l'aplicaci贸
                  </Text>
                </View>
                {selectedRole === 'user' && (
                  <MaterialIcons name="check-circle" size={24} color={Colors.success} />
                )}
              </TouchableOpacity>

              <TouchableOpacity
                style={[
                  styles.roleOption,
                  selectedRole === 'local_associat' && styles.roleOptionSelected,
                ]}
                onPress={() => setSelectedRole('local_associat')}
              >
                <MaterialIcons
                  name="store"
                  size={24}
                  color={selectedRole === 'local_associat' ? Colors.accent : Colors.gray}
                />
                <View style={styles.roleOptionInfo}>
                  <Text
                    style={[
                      styles.roleOptionTitle,
                      selectedRole === 'local_associat' && styles.roleOptionTitleSelected,
                    ]}
                  >
                    Local Associat
                  </Text>
                  <Text style={styles.roleOptionDescription}>
                    Pot crear promocions i gestionar el seu establiment
                  </Text>
                </View>
                {selectedRole === 'local_associat' && (
                  <MaterialIcons name="check-circle" size={24} color={Colors.accent} />
                )}
              </TouchableOpacity>

              <TouchableOpacity
                style={[
                  styles.roleOption,
                  selectedRole === 'entitat_colaboradora' && styles.roleOptionSelected,
                ]}
                onPress={() => setSelectedRole('entitat_colaboradora')}
              >
                <MaterialIcons
                  name="business"
                  size={24}
                  color={selectedRole === 'entitat_colaboradora' ? Colors.primary : Colors.gray}
                />
                <View style={styles.roleOptionInfo}>
                  <Text
                    style={[
                      styles.roleOptionTitle,
                      selectedRole === 'entitat_colaboradora' && styles.roleOptionTitleSelected,
                    ]}
                  >
                    Entitat Col路laboradora
                  </Text>
                  <Text style={styles.roleOptionDescription}>
                    Pot crear promocions i continguts
                  </Text>
                </View>
                {selectedRole === 'entitat_colaboradora' && (
                  <MaterialIcons name="check-circle" size={24} color={Colors.primary} />
                )}
              </TouchableOpacity>

              <TouchableOpacity
                style={[
                  styles.roleOption,
                  selectedRole === 'membre_consell' && styles.roleOptionSelected,
                ]}
                onPress={() => setSelectedRole('membre_consell')}
              >
                <MaterialIcons
                  name="account-balance"
                  size={24}
                  color={selectedRole === 'membre_consell' ? '#9C27B0' : Colors.gray}
                />
                <View style={styles.roleOptionInfo}>
                  <Text
                    style={[
                      styles.roleOptionTitle,
                      selectedRole === 'membre_consell' && styles.roleOptionTitleSelected,
                    ]}
                  >
                    Membre del Consell
                  </Text>
                  <Text style={styles.roleOptionDescription}>
                    Membre del consell rector amb acc茅s especial
                  </Text>
                </View>
                {selectedRole === 'membre_consell' && (
                  <MaterialIcons name="check-circle" size={24} color="#9C27B0" />
                )}
              </TouchableOpacity>

              <TouchableOpacity
                style={[
                  styles.roleOption,
                  selectedRole === 'admin' && styles.roleOptionSelected,
                ]}
                onPress={() => setSelectedRole('admin')}
              >
                <MaterialIcons
                  name="admin-panel-settings"
                  size={24}
                  color={selectedRole === 'admin' ? Colors.error : Colors.gray}
                />
                <View style={styles.roleOptionInfo}>
                  <Text
                    style={[
                      styles.roleOptionTitle,
                      selectedRole === 'admin' && styles.roleOptionTitleSelected,
                    ]}
                  >
                    Administrador
                  </Text>
                  <Text style={styles.roleOptionDescription}>
                    Acc茅s complet al backoffice
                  </Text>
                </View>
                {selectedRole === 'admin' && (
                  <MaterialIcons name="check-circle" size={24} color={Colors.error} />
                )}
              </TouchableOpacity>
              
              {/* Secci贸 per assignar establiment si 茅s local associat */}
              {selectedRole === 'local_associat' && (
                <View style={styles.establishmentSection}>
                  <Text style={styles.sectionTitle}> Assignar Establiment</Text>
                  
                  <TouchableOpacity
                    style={styles.establishmentPickerButton}
                    onPress={() => setShowEstablishmentPicker(!showEstablishmentPicker)}
                  >
                    <MaterialIcons name="store" size={20} color={Colors.primary} />
                    <Text style={styles.establishmentPickerText}>
                      {selectedEstablishmentId 
                        ? establishments.find(e => e._id === selectedEstablishmentId || e.id === selectedEstablishmentId)?.name || 'Seleccionar establiment'
                        : 'Seleccionar establiment'}
                    </Text>
                    <MaterialIcons 
                      name={showEstablishmentPicker ? "expand-less" : "expand-more"} 
                      size={24} 
                      color={Colors.text} 
                    />
                  </TouchableOpacity>
                  
                  {showEstablishmentPicker && (
                    <View style={styles.establishmentPickerContainer}>
                      {/* Camp de cerca amb lupa */}
                      <View style={styles.establishmentSearchContainer}>
                        <MaterialIcons name="search" size={20} color={Colors.gray} />
                        <TextInput
                          style={styles.establishmentSearchInput}
                          placeholder="Buscar establiment per nom..."
                          value={establishmentSearchQuery}
                          onChangeText={setEstablishmentSearchQuery}
                          autoCapitalize="none"
                        />
                        {establishmentSearchQuery.length > 0 && (
                          <TouchableOpacity onPress={() => setEstablishmentSearchQuery('')}>
                            <MaterialIcons name="close" size={20} color={Colors.gray} />
                          </TouchableOpacity>
                        )}
                      </View>

                      {/* Llista d'establiments filtrats */}
                      <ScrollView style={styles.establishmentList} nestedScrollEnabled>
                        {filteredEstablishments.length === 0 ? (
                          <View style={styles.noResultsContainer}>
                            <Text style={styles.noResultsText}>
                              No s'han trobat establiments
                            </Text>
                          </View>
                        ) : (
                          filteredEstablishments.map((est) => (
                            <Pressable
                              key={est._id || est.id}
                              style={({ pressed }) => [
                                styles.establishmentItem,
                                (selectedEstablishmentId === est._id || selectedEstablishmentId === est.id) && 
                                styles.establishmentItemSelected,
                                pressed && { opacity: 0.7 }
                              ]}
                              onPress={() => {
                                console.log('Establishment selected:', est.name);
                                setSelectedEstablishmentId(est._id || est.id);
                                setShowEstablishmentPicker(false);
                                setEstablishmentSearchQuery(''); // Netejar la cerca
                              }}
                            >
                              <Text style={styles.establishmentItemName}>{est.name}</Text>
                              {est.address && (
                                <Text style={styles.establishmentItemAddress}>{est.address}</Text>
                              )}
                            </Pressable>
                          ))
                        )}
                      </ScrollView>
                    </View>
                  )}
                  
                  {selectedEstablishmentId && (
                    <TouchableOpacity
                      style={styles.assignButton}
                      onPress={handleAssignEstablishment}
                      disabled={loadingEstablishment}
                    >
                      {loadingEstablishment ? (
                        <ActivityIndicator color={Colors.white} />
                      ) : (
                        <>
                          <MaterialIcons name="link" size={20} color={Colors.white} />
                          <Text style={styles.assignButtonText}>Assignar Establiment</Text>
                        </>
                      )}
                    </TouchableOpacity>
                  )}
                </View>
              )}
            </ScrollView>

            <View style={styles.modalFooter}>
              <TouchableOpacity
                style={[styles.modalButton, styles.cancelButton]}
                onPress={() => setModalVisible(false)}
              >
                <Text style={styles.cancelButtonText}>Cancel路lar</Text>
              </TouchableOpacity>

              <Pressable
                style={({ pressed }) => [
                  styles.modalButton,
                  styles.saveButton,
                  pressed && { opacity: 0.7 }
                ]}
                onPress={() => {
                  console.log('Save button pressed');
                  handleSaveRole();
                }}
              >
                <Text style={styles.saveButtonText}>Guardar</Text>
              </Pressable>
            </View>
          </View>
        </View>
      </Modal>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: Colors.background,
  },
  centered: {
    justifyContent: 'center',
    alignItems: 'center',
  },
  header: {
    backgroundColor: Colors.primary,
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingHorizontal: Spacing.md,
    paddingVertical: Spacing.md,
  },
  backButton: {
    padding: Spacing.sm,
  },
  headerTitle: {
    fontSize: FontSizes.xl,
    fontWeight: 'bold',
    color: Colors.white,
  },
  placeholder: {
    width: 40,
  },
  searchContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: Colors.white,
    margin: Spacing.md,
    paddingHorizontal: Spacing.md,
    borderRadius: BorderRadius.lg,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 3,
  },
  searchInput: {
    flex: 1,
    paddingVertical: Spacing.md,
    paddingHorizontal: Spacing.sm,
    fontSize: FontSizes.md,
    color: Colors.text,
  },
  statsContainer: {
    flexDirection: 'row',
    paddingHorizontal: Spacing.md,
    gap: Spacing.sm,
    marginBottom: Spacing.md,
  },
  statCard: {
    flex: 1,
    backgroundColor: Colors.white,
    padding: Spacing.md,
    borderRadius: BorderRadius.md,
    alignItems: 'center',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.1,
    shadowRadius: 2,
    elevation: 2,
  },
  statNumber: {
    fontSize: FontSizes.xxl,
    fontWeight: 'bold',
    color: Colors.primary,
  },
  statLabel: {
    fontSize: FontSizes.xs,
    color: Colors.textSecondary,
    marginTop: 4,
  },
  content: {
    flex: 1,
  },
  contentContainer: {
    paddingBottom: 100,
  },
  emptyState: {
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: Spacing.xxl * 2,
  },
  emptyText: {
    fontSize: FontSizes.lg,
    color: Colors.textSecondary,
    marginTop: Spacing.lg,
  },
  card: {
    backgroundColor: Colors.white,
    marginHorizontal: Spacing.md,
    marginBottom: Spacing.md,
    padding: Spacing.md,
    borderRadius: BorderRadius.lg,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 3,
  },
  userHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: Spacing.sm,
  },
  avatarContainer: {
    width: 56,
    height: 56,
    borderRadius: 28,
    backgroundColor: Colors.background,
    justifyContent: 'center',
    alignItems: 'center',
    marginRight: Spacing.md,
  },
  userInfo: {
    flex: 1,
  },
  userName: {
    fontSize: FontSizes.lg,
    fontWeight: 'bold',
    color: Colors.text,
  },
  userEmail: {
    fontSize: FontSizes.sm,
    color: Colors.textSecondary,
    marginTop: 2,
  },
  roleBadge: {
    paddingHorizontal: Spacing.sm,
    paddingVertical: 4,
    borderRadius: BorderRadius.sm,
  },
  roleText: {
    fontSize: FontSizes.xs,
    fontWeight: 'bold',
  },
  detailRow: {
    flexDirection: 'row',
    alignItems: 'center',
    marginTop: Spacing.xs,
  },
  detailText: {
    fontSize: FontSizes.sm,
    color: Colors.textSecondary,
    marginLeft: Spacing.xs,
  },
  actionButtonsContainer: {
    flexDirection: 'row',
    gap: Spacing.sm,
    marginTop: Spacing.md,
  },
  changeRoleButton: {
    flex: 1,
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: Colors.primary + '20',
    paddingVertical: Spacing.sm,
    borderRadius: BorderRadius.md,
  },
  changeRoleText: {
    color: Colors.primary,
    fontWeight: '600',
    marginLeft: Spacing.xs,
  },
  deleteButton: {
    width: 44,
    height: 44,
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: Colors.error + '20',
    borderRadius: BorderRadius.md,
  },
  buttonDisabled: {
    opacity: 0.4,
  },
  statsScrollView: {
    maxHeight: 80,
  },
  currentUserBadge: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: Colors.accent + '20',
    paddingVertical: Spacing.sm,
    borderRadius: BorderRadius.md,
    marginTop: Spacing.md,
  },
  currentUserText: {
    color: Colors.accent,
    fontWeight: '600',
    marginLeft: Spacing.xs,
  },
  // Modal styles
  modalContainer: {
    flex: 1,
    backgroundColor: 'rgba(0,0,0,0.5)',
    justifyContent: 'center',
    alignItems: 'center',
  },
  modalContent: {
    backgroundColor: Colors.white,
    borderRadius: BorderRadius.xl,
    width: '90%',
    maxWidth: 400,
    maxHeight: '80%',
  },
  modalHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: Spacing.lg,
    borderBottomWidth: 1,
    borderBottomColor: Colors.lightGray,
  },
  modalTitle: {
    fontSize: FontSizes.xl,
    fontWeight: 'bold',
    color: Colors.text,
  },
  modalBody: {
    padding: Spacing.lg,
  },
  modalUserName: {
    fontSize: FontSizes.lg,
    fontWeight: 'bold',
    color: Colors.text,
    textAlign: 'center',
  },
  modalUserEmail: {
    fontSize: FontSizes.md,
    color: Colors.textSecondary,
    textAlign: 'center',
    marginBottom: Spacing.lg,
  },
  label: {
    fontSize: FontSizes.md,
    fontWeight: '600',
    color: Colors.text,
    marginBottom: Spacing.md,
  },
  roleOption: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: Spacing.md,
    borderRadius: BorderRadius.md,
    borderWidth: 2,
    borderColor: Colors.lightGray,
    marginBottom: Spacing.md,
  },
  roleOptionSelected: {
    borderColor: Colors.primary,
    backgroundColor: Colors.primary + '10',
  },
  roleOptionInfo: {
    flex: 1,
    marginLeft: Spacing.md,
  },
  roleOptionTitle: {
    fontSize: FontSizes.md,
    fontWeight: '600',
    color: Colors.text,
  },
  roleOptionTitleSelected: {
    color: Colors.primary,
  },
  roleOptionDescription: {
    fontSize: FontSizes.sm,
    color: Colors.textSecondary,
    marginTop: 2,
  },
  modalFooter: {
    flexDirection: 'row',
    padding: Spacing.lg,
    borderTopWidth: 1,
    borderTopColor: Colors.lightGray,
    gap: Spacing.md,
  },
  modalButton: {
    flex: 1,
    paddingVertical: Spacing.md,
    borderRadius: BorderRadius.lg,
    alignItems: 'center',
  },
  cancelButton: {
    backgroundColor: Colors.background,
    borderWidth: 1,
    borderColor: Colors.lightGray,
  },
  cancelButtonText: {
    color: Colors.text,
    fontSize: FontSizes.md,
    fontWeight: '600',
  },
  saveButton: {
    backgroundColor: Colors.primary,
  },
  saveButtonText: {
    color: Colors.white,
    fontSize: FontSizes.md,
    fontWeight: 'bold',
  },
  // New styles for simplified UI
  userRow: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: Spacing.lg,
  },
  avatarCircle: {
    width: 60,
    height: 60,
    borderRadius: 30,
    backgroundColor: Colors.primary,
    justifyContent: 'center',
    alignItems: 'center',
    marginRight: Spacing.md,
  },
  userDetails: {
    flex: 1,
  },
  roleTag: {
    paddingHorizontal: Spacing.sm,
    paddingVertical: 4,
    borderRadius: BorderRadius.sm,
    marginTop: Spacing.xs,
    alignSelf: 'flex-start',
  },
  roleTagText: {
    fontSize: FontSizes.xs,
    fontWeight: 'bold',
  },
  buttonRow: {
    flexDirection: 'row',
    gap: Spacing.md,
  },
  editButton: {
    flex: 1,
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: Colors.primary,
    paddingVertical: Spacing.lg,
    borderRadius: BorderRadius.lg,
    gap: Spacing.sm,
  },
  editButtonText: {
    color: Colors.white,
    fontSize: FontSizes.md,
    fontWeight: 'bold',
  },
  deleteButtonNew: {
    width: 60,
    height: 60,
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: Colors.error,
    borderRadius: BorderRadius.lg,
  },
  currentUserInfo: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: Colors.accent + '20',
    paddingVertical: Spacing.md,
    borderRadius: BorderRadius.lg,
    gap: Spacing.sm,
  },
  currentUserText: {
    fontSize: FontSizes.md,
    fontWeight: '600',
    color: Colors.accent,
  },
  establishmentSection: {
    marginTop: Spacing.lg,
    padding: Spacing.md,
    backgroundColor: Colors.background,
    borderRadius: BorderRadius.md,
  },
  sectionTitle: {
    fontSize: FontSizes.md,
    fontWeight: 'bold',
    color: Colors.text,
    marginBottom: Spacing.md,
  },
  establishmentPickerButton: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: Colors.white,
    padding: Spacing.md,
    borderRadius: BorderRadius.md,
    borderWidth: 1,
    borderColor: Colors.lightGray,
    marginBottom: Spacing.sm,
  },
  establishmentPickerText: {
    flex: 1,
    marginLeft: Spacing.sm,
    fontSize: FontSizes.md,
    color: Colors.text,
  },
  establishmentPickerContainer: {
    backgroundColor: Colors.white,
    borderRadius: BorderRadius.md,
    borderWidth: 1,
    borderColor: Colors.lightGray,
    marginBottom: Spacing.md,
  },
  establishmentSearchContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: Colors.background,
    paddingHorizontal: Spacing.sm,
    paddingVertical: Spacing.xs,
    borderBottomWidth: 1,
    borderBottomColor: Colors.lightGray,
  },
  establishmentSearchInput: {
    flex: 1,
    paddingHorizontal: Spacing.sm,
    paddingVertical: Spacing.xs,
    fontSize: FontSizes.sm,
    color: Colors.text,
  },
  noResultsContainer: {
    padding: Spacing.lg,
    alignItems: 'center',
  },
  noResultsText: {
    fontSize: FontSizes.sm,
    color: Colors.textSecondary,
    textAlign: 'center',
  },
  establishmentList: {
    maxHeight: 200,
    backgroundColor: Colors.white,
    borderRadius: BorderRadius.md,
    borderWidth: 1,
    borderColor: Colors.lightGray,
    marginBottom: Spacing.md,
  },
  establishmentItem: {
    padding: Spacing.md,
    borderBottomWidth: 1,
    borderBottomColor: Colors.lightGray,
  },
  establishmentItemSelected: {
    backgroundColor: Colors.primary + '15',
  },
  establishmentItemName: {
    fontSize: FontSizes.md,
    fontWeight: '600',
    color: Colors.text,
  },
  establishmentItemAddress: {
    fontSize: FontSizes.sm,
    color: Colors.textSecondary,
    marginTop: 2,
  },
  assignButton: {
    flexDirection: 'row',
    backgroundColor: Colors.primary,
    padding: Spacing.md,
    borderRadius: BorderRadius.md,
    alignItems: 'center',
    justifyContent: 'center',
    gap: Spacing.sm,
  },
  assignButtonText: {
    color: Colors.white,
    fontSize: FontSizes.md,
    fontWeight: 'bold',
  },
});
