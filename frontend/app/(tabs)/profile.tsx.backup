import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  ScrollView,
  TouchableOpacity,
  Alert,
  RefreshControl,
  Modal,
  SafeAreaView,
} from 'react-native';
import { useRouter } from 'expo-router';
import { MaterialIcons } from '@expo/vector-icons';
import QRCode from 'react-native-qrcode-svg';
import { useAuthStore } from '../../src/store/authStore';
import { giftCardsService, authService } from '../../src/services/api';
import { Colors, Spacing, BorderRadius, FontSizes } from '../../src/constants/colors';
import type { GiftCard } from '../../src/types';
import i18n, { changeLanguage, getCurrentLanguage } from '../../src/i18n';

export default function ProfileScreen() {
  const router = useRouter();
  const { user, logout } = useAuthStore();
  const [giftCards, setGiftCards] = useState<GiftCard[]>([]);
  const [refreshing, setRefreshing] = useState(false);
  const [showLanguageModal, setShowLanguageModal] = useState(false);
  const [currentLanguage, setCurrentLanguage] = useState(getCurrentLanguage());

  const languages = [
    { code: 'ca', name: 'Catal√†', flag: 'üá™üá∏' },
    { code: 'es', name: 'Espa√±ol', flag: 'üá™üá∏' },
    { code: 'en', name: 'English', flag: 'üá¨üáß' },
    { code: 'fr', name: 'Fran√ßais', flag: 'üá´üá∑' },
    { code: 'it', name: 'Italiano', flag: 'üáÆüáπ' },
    { code: 'ru', name: '–†—É—Å—Å–∫–∏–π', flag: 'üá∑üá∫' },
  ];

  useEffect(() => {
    if (user) {
      console.log('User role:', user.role);
      console.log('Full user:', user);
      loadGiftCards();
    }
  }, [user]);

  const loadGiftCards = async () => {
    try {
      if (user) {
        const data = await giftCardsService.getUserCards(user.id);
        setGiftCards(data);
      }
    } catch (error) {
      console.error('Error loading gift cards:', error);
    } finally {
      setRefreshing(false);
    }
  };

  const onRefresh = () => {
    setRefreshing(true);
    loadGiftCards();
  };

  const handleLogout = async () => {
    console.log('handleLogout called - Direct logout');
    try {
      await logout();
      console.log('Logout successful, navigating to login');
      router.replace('/auth/login');
    } catch (error) {
      console.error('Logout error:', error);
      Alert.alert('Error', 'No se pudo cerrar sesi√≥n');
    }
  };

  const handleLanguageChange = async (languageCode: string) => {
    try {
      // Change language in i18n
      changeLanguage(languageCode);
      setCurrentLanguage(languageCode);
      
      // Save language preference to backend
      if (user) {
        const token = await useAuthStore.getState().token;
        if (token) {
          await authService.updateLanguage(languageCode, token);
        }
      }
      
      setShowLanguageModal(false);
      
      // Show success message
      Alert.alert(
        i18n.t('common.success'),
        'Language updated successfully!',
        [{ text: i18n.t('common.ok') }]
      );
    } catch (error) {
      console.error('Error updating language:', error);
      Alert.alert(
        i18n.t('common.error'),
        'Could not update language preference',
        [{ text: i18n.t('common.ok') }]
      );
    }
  };

  return (
    <SafeAreaView style={{ flex: 1, backgroundColor: Colors.background }}>
      <ScrollView
        style={styles.container}
        contentContainerStyle={styles.contentContainer}
        refreshControl={
          <RefreshControl refreshing={refreshing} onRefresh={onRefresh} colors={[Colors.primary]} />
        }
      >
      {/* User Info Section */}
      <View style={styles.header}>
        <View style={styles.headerContent}>
          <View style={styles.userInfo}>
            <View style={styles.avatar}>
              <MaterialIcons name="person" size={60} color={Colors.white} />
            </View>
            <View style={styles.userTextContainer}>
              <Text style={styles.userName}>{user?.name}</Text>
              <Text style={styles.userEmail}>{user?.email}</Text>
              {user?.member_code && (
                <View style={styles.memberCodeBadge}>
                  <MaterialIcons name="badge" size={14} color={Colors.primary} />
                  <Text style={styles.memberCodeText}>{user.member_code}</Text>
                </View>
              )}
            </View>
          </View>
          
          {/* QR Code - Carnet d'Identitat */}
          {user?.member_code && (
            <View style={styles.qrContainer}>
              <View style={styles.qrCard}>
                <QRCode
                  value={user.member_code}
                  size={100}
                  backgroundColor="white"
                  color={Colors.primary}
                />
                <Text style={styles.qrLabel}>Carnet de Soci</Text>
              </View>
            </View>
          )}
        </View>
      </View>

      {/* Gift Cards Section */}
      <View style={styles.section}>
        <View style={styles.sectionHeader}>
          <Text style={styles.sectionTitle}>Mis Tarjetas Regalo</Text>
          <TouchableOpacity onPress={() => router.push('/gift-cards/purchase')}>
            <MaterialIcons name="add-circle" size={28} color={Colors.primary} />
          </TouchableOpacity>
        </View>

        {giftCards.length === 0 ? (
          <View style={styles.emptyCard}>
            <MaterialIcons name="card-giftcard" size={60} color={Colors.lightGray} />
            <Text style={styles.emptyText}>No tienes tarjetas regalo</Text>
            <TouchableOpacity
              style={styles.addButton}
              onPress={() => router.push('/gift-cards/purchase')}
            >
              <Text style={styles.addButtonText}>Comprar Tarjeta Regalo</Text>
            </TouchableOpacity>
          </View>
        ) : (
          giftCards.map((card) => (
            <View key={card.id} style={styles.giftCard}>
              <View style={styles.giftCardHeader}>
                <View style={styles.giftCardIcon}>
                  <MaterialIcons name="card-giftcard" size={32} color={Colors.primary} />
                </View>
                <View style={styles.giftCardInfo}>
                  <Text style={styles.giftCardCode}>C√≥digo: {card.code}</Text>
                  <Text style={styles.giftCardStatus}>
                    {card.status === 'active' ? 'Activa' : card.status === 'used' ? 'Usada' : 'Expirada'}
                  </Text>
                </View>
              </View>
              <View style={styles.giftCardFooter}>
                <View>
                  <Text style={styles.balanceLabel}>Saldo disponible</Text>
                  <Text style={styles.balanceAmount}>{card.balance.toFixed(2)} ‚Ç¨</Text>
                </View>
                <TouchableOpacity
                  style={styles.detailsButton}
                  onPress={() => router.push(`/gift-cards/${card.id}`)}
                >
                  <Text style={styles.detailsButtonText}>Ver detalles</Text>
                  <MaterialIcons name="arrow-forward" size={16} color={Colors.primary} />
                </TouchableOpacity>
              </View>
            </View>
          ))
        )}
      </View>

      {/* Admin Section - Only visible for admin users */}
      {user?.role === 'admin' && (
        <View style={styles.section}>
          <Text style={styles.sectionTitle}>Administraci√≥n</Text>
          <TouchableOpacity
            style={styles.adminButton}
            onPress={() => router.push('/admin')}
          >
            <MaterialIcons name="admin-panel-settings" size={24} color={Colors.white} />
            <Text style={styles.adminButtonText}>Acceder al Backoffice</Text>
            <MaterialIcons name="chevron-right" size={24} color={Colors.white} />
          </TouchableOpacity>
        </View>
      )}

      {/* Local Associate Section */}
      {user?.role === 'local_associat' && (
        <View style={styles.section}>
          <Text style={styles.sectionTitle}>El Meu Establiment</Text>
          <TouchableOpacity
            style={styles.establishmentButton}
            onPress={() => router.push('/my-establishment')}
          >
            <MaterialIcons name="store" size={24} color={Colors.white} />
            <Text style={styles.establishmentButtonText}>Gestionar Establiment</Text>
            <MaterialIcons name="chevron-right" size={24} color={Colors.white} />
          </TouchableOpacity>
          
          <TouchableOpacity
            style={[styles.establishmentButton, { marginTop: Spacing.md, backgroundColor: Colors.secondary }]}
            onPress={() => router.push('/local-associat/offers')}
          >
            <MaterialIcons name="local-offer" size={24} color={Colors.white} />
            <Text style={styles.establishmentButtonText}>Les Meves Promocions</Text>
            <MaterialIcons name="chevron-right" size={24} color={Colors.white} />
          </TouchableOpacity>
        </View>
      )}
      
      {/* Debug info - Temporary */}
      {user && (
        <View style={[styles.section, { backgroundColor: '#f0f0f0', padding: Spacing.md }]}>
          <Text style={{ fontSize: 12, color: '#666' }}>
            Debug Info - Rol actual: {user.role || 'undefined'}
          </Text>
          <Text style={{ fontSize: 10, color: '#999', marginTop: 4 }}>
            Si has canviat el rol, tanca sessi√≥ i torna a entrar
          </Text>
        </View>
      )}

      {/* Menu Options */}
      <View style={styles.section}>
        <TouchableOpacity 
          style={styles.menuItem}
          onPress={() => router.push('/privacy-policy')}
        >
          <MaterialIcons name="security" size={24} color={Colors.text} />
          <Text style={styles.menuText}>Protecci√≥ de Dades</Text>
          <MaterialIcons name="chevron-right" size={24} color={Colors.gray} />
        </TouchableOpacity>

        <TouchableOpacity style={styles.menuItem}>
          <MaterialIcons name="history" size={24} color={Colors.text} />
          <Text style={styles.menuText}>Historial de tickets</Text>
          <MaterialIcons name="chevron-right" size={24} color={Colors.gray} />
        </TouchableOpacity>

        <TouchableOpacity style={styles.menuItem}>
          <MaterialIcons name="notifications" size={24} color={Colors.text} />
          <Text style={styles.menuText}>Notificaciones</Text>
          <MaterialIcons name="chevron-right" size={24} color={Colors.gray} />
        </TouchableOpacity>

        <TouchableOpacity style={styles.menuItem}>
          <MaterialIcons name="settings" size={24} color={Colors.text} />
          <Text style={styles.menuText}>Configuraci√≥n</Text>
          <MaterialIcons name="chevron-right" size={24} color={Colors.gray} />
        </TouchableOpacity>

        <TouchableOpacity 
          style={styles.menuItem}
          onPress={() => setShowLanguageModal(true)}
        >
          <MaterialIcons name="language" size={24} color={Colors.text} />
          <Text style={styles.menuText}>Idioma / Language</Text>
          <View style={styles.languageIndicator}>
            <Text style={styles.languageCode}>{currentLanguage.toUpperCase()}</Text>
            <MaterialIcons name="chevron-right" size={24} color={Colors.gray} />
          </View>
        </TouchableOpacity>

        <TouchableOpacity style={styles.menuItem}>
          <MaterialIcons name="help" size={24} color={Colors.text} />
          <Text style={styles.menuText}>Ayuda y soporte</Text>
          <MaterialIcons name="chevron-right" size={24} color={Colors.gray} />
        </TouchableOpacity>

        <TouchableOpacity style={styles.menuItem}>
          <MaterialIcons name="info" size={24} color={Colors.text} />
          <Text style={styles.menuText}>Acerca de</Text>
          <MaterialIcons name="chevron-right" size={24} color={Colors.gray} />
        </TouchableOpacity>
      </View>

    </ScrollView>

      {/* Logout Button - Outside ScrollView */}
      <TouchableOpacity 
        style={styles.logoutButton} 
        onPress={handleLogout}
        activeOpacity={0.7}
        testID="logout-button"
      >
        <MaterialIcons name="logout" size={24} color={Colors.white} />
        <Text style={styles.logoutText}>Cerrar sesi√≥n</Text>
      </TouchableOpacity>

      {/* Language Selection Modal */}
      {showLanguageModal && (
        <Modal
          visible={true}
          transparent
          animationType="slide"
          onRequestClose={() => setShowLanguageModal(false)}
        >
          <View style={styles.modalOverlay}>
            <View style={styles.modalContent}>
              <View style={styles.modalHeader}>
                <Text style={styles.modalTitle}>Selecciona Idioma / Select Language</Text>
                <TouchableOpacity onPress={() => setShowLanguageModal(false)}>
                  <MaterialIcons name="close" size={24} color={Colors.text} />
                </TouchableOpacity>
              </View>
              
              <ScrollView style={styles.languageList}>
                {languages.map((lang) => (
                  <TouchableOpacity
                    key={lang.code}
                    style={[
                      styles.languageOption,
                      currentLanguage === lang.code && styles.languageOptionSelected,
                    ]}
                    onPress={() => handleLanguageChange(lang.code)}
                  >
                    <Text style={styles.languageFlag}>{lang.flag}</Text>
                    <Text style={[
                      styles.languageName,
                      currentLanguage === lang.code && styles.languageNameSelected,
                    ]}>
                      {lang.name}
                    </Text>
                    {currentLanguage === lang.code && (
                      <MaterialIcons name="check" size={24} color={Colors.primary} />
                    )}
                  </TouchableOpacity>
                ))}
              </ScrollView>
            </View>
          </View>
        </Modal>
      )}
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: Colors.background,
  },
  contentContainer: {
    paddingBottom: 100, // Espai per al men√∫ inferior dels tabs
  },
  header: {
    backgroundColor: Colors.primary,
    paddingVertical: Spacing.xxl,
    paddingHorizontal: Spacing.lg,
  },
  headerContent: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    width: '100%',
  },
  userInfo: {
    flexDirection: 'row',
    alignItems: 'center',
    flex: 1,
  },
  avatar: {
    width: 80,
    height: 80,
    borderRadius: 40,
    backgroundColor: Colors.secondary,
    justifyContent: 'center',
    alignItems: 'center',
    marginRight: Spacing.md,
  },
  userTextContainer: {
    flex: 1,
  },
  userName: {
    fontSize: FontSizes.xl,
    fontWeight: 'bold',
    color: Colors.white,
    marginBottom: Spacing.xs,
  },
  userEmail: {
    fontSize: FontSizes.sm,
    color: Colors.white,
    opacity: 0.9,
    marginBottom: Spacing.xs,
  },
  memberCodeBadge: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: Colors.white,
    paddingHorizontal: Spacing.sm,
    paddingVertical: 4,
    borderRadius: BorderRadius.sm,
    alignSelf: 'flex-start',
    marginTop: Spacing.xs,
  },
  memberCodeText: {
    fontSize: FontSizes.xs,
    fontWeight: '600',
    color: Colors.primary,
    marginLeft: 4,
  },
  qrContainer: {
    marginLeft: Spacing.md,
  },
  qrCard: {
    backgroundColor: Colors.white,
    padding: Spacing.sm,
    borderRadius: BorderRadius.md,
    alignItems: 'center',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.2,
    shadowRadius: 4,
    elevation: 5,
  },
  qrLabel: {
    fontSize: FontSizes.xs,
    fontWeight: '600',
    color: Colors.primary,
    marginTop: Spacing.xs,
  },
  section: {
    backgroundColor: Colors.white,
    marginTop: Spacing.md,
    padding: Spacing.lg,
  },
  sectionHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: Spacing.md,
  },
  sectionTitle: {
    fontSize: FontSizes.xl,
    fontWeight: 'bold',
    color: Colors.text,
  },
  emptyCard: {
    alignItems: 'center',
    paddingVertical: Spacing.xxl,
  },
  emptyText: {
    fontSize: FontSizes.md,
    color: Colors.textSecondary,
    marginTop: Spacing.md,
    marginBottom: Spacing.lg,
  },
  addButton: {
    backgroundColor: Colors.primary,
    paddingHorizontal: Spacing.xl,
    paddingVertical: Spacing.md,
    borderRadius: BorderRadius.lg,
  },
  addButtonText: {
    color: Colors.white,
    fontSize: FontSizes.md,
    fontWeight: 'bold',
  },
  giftCard: {
    backgroundColor: Colors.background,
    borderRadius: BorderRadius.lg,
    padding: Spacing.md,
    marginBottom: Spacing.md,
    borderWidth: 1,
    borderColor: Colors.lightGray,
  },
  giftCardHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: Spacing.md,
  },
  giftCardIcon: {
    width: 60,
    height: 60,
    borderRadius: BorderRadius.lg,
    backgroundColor: Colors.primary + '20',
    justifyContent: 'center',
    alignItems: 'center',
    marginRight: Spacing.md,
  },
  giftCardInfo: {
    flex: 1,
  },
  giftCardCode: {
    fontSize: FontSizes.md,
    fontWeight: '600',
    color: Colors.text,
    marginBottom: Spacing.xs,
  },
  giftCardStatus: {
    fontSize: FontSizes.sm,
    color: Colors.success,
    fontWeight: '600',
  },
  giftCardFooter: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    borderTopWidth: 1,
    borderTopColor: Colors.lightGray,
    paddingTop: Spacing.md,
  },
  balanceLabel: {
    fontSize: FontSizes.xs,
    color: Colors.textSecondary,
    marginBottom: 4,
  },
  balanceAmount: {
    fontSize: FontSizes.xl,
    fontWeight: 'bold',
    color: Colors.text,
  },
  detailsButton: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  detailsButtonText: {
    fontSize: FontSizes.sm,
    color: Colors.primary,
    fontWeight: '600',
    marginRight: Spacing.xs,
  },
  menuItem: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: Spacing.md,
    borderBottomWidth: 1,
    borderBottomColor: Colors.lightGray,
  },
  menuText: {
    flex: 1,
    fontSize: FontSizes.md,
    color: Colors.text,
    marginLeft: Spacing.md,
  },
  logoutButton: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: Colors.error,
    marginTop: Spacing.md,
    marginHorizontal: Spacing.lg,
    marginBottom: 80,
    padding: Spacing.lg,
    borderRadius: BorderRadius.lg,
    borderWidth: 2,
    borderColor: Colors.error,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.25,
    shadowRadius: 3.84,
    elevation: 5,
    cursor: 'pointer',
  },
  logoutText: {
    fontSize: FontSizes.md,
    color: Colors.white,
    fontWeight: 'bold',
    marginLeft: Spacing.sm,
  },
  footer: {
    alignItems: 'center',
    paddingVertical: Spacing.xl,
  },
  footerText: {
    fontSize: FontSizes.xs,
    color: Colors.textSecondary,
  },
  adminButton: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    backgroundColor: Colors.primary,
    padding: Spacing.md,
    borderRadius: BorderRadius.lg,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.2,
    shadowRadius: 4,
    elevation: 4,
  },
  adminButtonText: {
    flex: 1,
    fontSize: FontSizes.md,
    color: Colors.white,
    fontWeight: 'bold',
    marginLeft: Spacing.sm,
  },
  establishmentButton: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    backgroundColor: Colors.accent,
    padding: Spacing.lg,
    borderRadius: BorderRadius.lg,
    shadowColor: Colors.shadow,
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.2,
    shadowRadius: 4,
    elevation: 4,
  },
  establishmentButtonText: {
    flex: 1,
    marginLeft: Spacing.md,
    fontSize: FontSizes.md,
    fontWeight: 'bold',
    color: Colors.white,
  },
  languageIndicator: {
    flexDirection: 'row',
    alignItems: 'center',
    marginLeft: 'auto',
  },
  languageCode: {
    fontSize: FontSizes.sm,
    fontWeight: '600',
    color: Colors.primary,
    marginRight: Spacing.xs,
  },
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    justifyContent: 'flex-end',
  },
  modalContent: {
    backgroundColor: Colors.white,
    borderTopLeftRadius: BorderRadius.xl,
    borderTopRightRadius: BorderRadius.xl,
    paddingBottom: Spacing.xl,
    maxHeight: '70%',
  },
  modalHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingHorizontal: Spacing.lg,
    paddingVertical: Spacing.md,
    borderBottomWidth: 1,
    borderBottomColor: Colors.lightGray,
  },
  modalTitle: {
    fontSize: FontSizes.lg,
    fontWeight: 'bold',
    color: Colors.text,
  },
  languageList: {
    paddingHorizontal: Spacing.lg,
  },
  languageOption: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: Spacing.md,
    paddingHorizontal: Spacing.md,
    borderRadius: BorderRadius.md,
    marginVertical: Spacing.xs,
  },
  languageOptionSelected: {
    backgroundColor: Colors.primary + '10',
  },
  languageFlag: {
    fontSize: 32,
    marginRight: Spacing.md,
  },
  languageName: {
    flex: 1,
    fontSize: FontSizes.md,
    color: Colors.text,
  },
  languageNameSelected: {
    fontWeight: 'bold',
    color: Colors.primary,
  },
});