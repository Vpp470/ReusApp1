<analysis>
<original_problem_statement>
The user's primary goal is to fix several critical bugs related to the Gimcana (Scavenger Hunt) and Scan Ticket features. The user is extremely frustrated with the current state of the application on their phone, despite multiple attempts by the agent to fix it.

**User's Final Bug Report (Highest Priority):**
1.  **Ticket Scanning Broken:** The Scan Ticket feature is not working as expected on the phone. The user reports that the camera-based OCR flow to read receipts, validate the establishment, and generate raffle participations is broken.
2.  **Gimcana Image Not Showing:** The main image for the Gimcana campaign is still not appearing on the user's device after deployment.
3.  **Gimcana QR Codes Regenerate on Edit:** When an admin edits an existing Gimcana campaign, the QR codes are being regenerated. This is incorrect; they should only be generated once upon creation unless explicitly requested.
4.  **Gimcana UI Not Updating:** After successfully scanning a QR code in a Gimcana, the user's progress display (X of Y QRs) does not update in real-time.
5.  **Scanning Hangs/Fails:** On the mobile app, both scanning a ticket QR and a Gimcana QR either gets stuck on a processing screen or the buttons to grant camera permission are unclickable.
</original_problem_statement>

**User's preferred language**: Catalan. The user exclusively communicates in Catalan. The next agent MUST respond in Catalan.

**what currently exists?**
The application's frontend has been significantly refactored to address multiple issues.
- **API URL Configuration:** The frontend API service () has been fixed to use the  environment variable, resolving 404 errors during local development.
- **Camera-Only Scanning:** Both the Gimcana () and Ticket Scanning () screens were modified to remove manual text input. On the web preview, they now show a message instructing the user to use the mobile app. On mobile, they are intended to open the camera directly.
- **Ticket Scanning ():** This file was heavily modified, breaking the original OCR functionality. The agent then restored the file from a previous git commit to bring back the intended logic (take photo, process with OCR). However, the user reports it is still not working correctly on the phone.
- **Gimcana Image Persistence:** The agent correctly identified that uploaded images were being lost on production due to an ephemeral filesystem. The image for the main Gimcana campaign was converted to a Base64 string and saved directly into the MongoDB document to ensure persistence. The agent verified this works locally, but the user reports it's still not working on production.
- **Promotions/Offers:** A major refactor was done to unify Offers and Promotions. The app now consistently uses Promotions and fetches data from the correct  endpoint, which was also fixed.

**Last working item**:
    - Last item agent was working: Addressing a list of critical bugs reported by the user in message 709. The agent had just finished analyzing the user's report and was about to start fixing the first issue: the broken ticket scanning and the missing gimcana photo. The last concrete action was acknowledging the user's list of problems.
    - Status: IN PROGRESS
    - Agent Testing Done: N
    - Which testing method agent to use? both. The issues span both frontend (UI not updating, buttons unclickable) and backend (QR codes regenerating). The primary focus should be on replicating the user's mobile experience. Manual testing with Expo Go QR code is essential.
    - User Testing Done: Y (User has tested on their phone and reported multiple critical failures).

**All Pending/In progress Issue list**:
  - Issue 1: **(P0) Ticket Scanning gets stuck on Processing....**
  - Issue 2: **(P0) Permetre Càmera button is unclickable in Gimcana and Club el tomb -> Escaneja Tiquets.**
  - Issue 3: **(P0) Gimcana Image Not Showing on Production.**
  - Issue 4: **(P1) Editing a Gimcana regenerates QR codes.**
  - Issue 5: **(P2) Gimcana QR scan UI does not update in real-time after a successful scan.**
  
  Issues Detail:
  - Issue 1: 
     - Attempted fixes: The agent identified that the  was missing from the  request payload, causing a 422 error. A fix was implemented in  to include the  from . However, the user reports the scan still hangs. The problem might be in the frontend UI not handling the response correctly or another backend issue.
     - Next debug checklist: 
        1. Review the  or equivalent function in .
        2. Add extensive  statements to track the state (, etc.) and the API response (both success and error).
        3. Verify the backend logs () for the  request when the user tests it to see what the backend is receiving and returning.
        4. Check the  block to ensure  is always called.
     - Why fix this issue and what will be achieved with the fix?: This is a core feature for user engagement (generating raffle entries). Fixing it is critical for the app's value proposition.
     - Status:  IN PROGRESS
     - Is recurring issue? Y
     - Should Test frontend/backend/both after fix?: both
     - Blocked on other issue: None.
  - Issue 2: 
     - Attempted fixes: The agent suspected  was failing inside a Modal and replaced it with  in . The user reported this did not fix the issue.
     - Next debug checklist: 
        1. Review the styling of the / and its parent containers. A common issue is a parent view intercepting touch events. Check for  issues or incorrect view positioning.
        2. In  and , wrap the button's  content in a  to confirm if the event is even firing.
        3. Test removing the component from the  (for Gimcana) and placing it on a simple view to see if the button works in isolation. This will confirm if the Modal is the problem.
     - Why fix this issue and what will be achieved with the fix?: The user cannot use any camera-based features without being able to grant permission. This is a complete blocker.
     - Status:  IN PROGRESS
     - Is recurring issue? Y
     - Should Test frontend/backend/both after fix?: frontend
     - Blocked on other issue: None.
  - Issue 3: 
     - Attempted fixes: The agent correctly diagnosed the ephemeral filesystem issue and migrated the image to a Base64 string in the MongoDB  collection. The agent has repeatedly verified locally that the API returns the Base64 string and the frontend renders it.
     - Next debug checklist: 
        1. **This is likely a deployment or caching issue.** First, confirm with the user that they have done a hard refresh or cleared the app's cache on their phone.
        2. Double-check that the last successful frontend build (yarn run v1.22.22
$ /app/frontend/node_modules/.bin/expo export
env: load .env.local .env.production .env
env: export EXPO_TUNNEL_SUBDOMAIN EXPO_PUBLIC_BACKEND_URL EXPO_PACKAGER_HOSTNAME EXPO_USE_FAST_RESOLVER METRO_CACHE_ROOT
Fast resolver is enabled.
Starting Metro Bundler
iOS node_modules/expo-router/entry.js ▓▓▓░░░░░░░░░░░░░ 21.3% ( 71/343)
Android node_modules/expo-router/entry.js ▓▓░░░░░░░░░░░░░░ 14.1% (18/48)
iOS node_modules/expo-router/entry.js ▓▓▓░░░░░░░░░░░░░ 21.3% (160/460)
Android node_modules/expo-router/entry.js ▓▓░░░░░░░░░░░░░░ 14.1% (119/382)
iOS node_modules/expo-router/entry.js ▓▓▓░░░░░░░░░░░░░ 21.3% (194/477)
Android node_modules/expo-router/entry.js ▓▓░░░░░░░░░░░░░░ 14.1% (119/382)
iOS node_modules/expo-router/entry.js ▓▓▓▓▓░░░░░░░░░░░ 34.3% (395/674)
Android node_modules/expo-router/entry.js ▓▓░░░░░░░░░░░░░░ 14.1% (175/487)
iOS node_modules/expo-router/entry.js ▓▓▓▓▓░░░░░░░░░░░ 34.3% (395/674)
Android node_modules/expo-router/entry.js ▓▓░░░░░░░░░░░░░░ 17.2% (223/538)
iOS node_modules/expo-router/entry.js ▓▓▓▓▓░░░░░░░░░░░ 34.3% (395/674)
Android node_modules/expo-router/entry.js ▓▓▓▓▓░░░░░░░░░░░ 34.4% (396/675)
iOS node_modules/expo-router/entry.js ▓▓▓▓▓▓▓▓░░░░░░░░ 51.0% (647/906)
Android node_modules/expo-router/entry.js ▓▓▓▓▓░░░░░░░░░░░ 34.4% (396/675)
iOS node_modules/expo-router/entry.js ▓▓▓▓▓▓▓▓░░░░░░░░ 54.7% (674/911)
Android node_modules/expo-router/entry.js ▓▓▓▓▓▓░░░░░░░░░░ 43.5% (589/893)
iOS node_modules/expo-router/entry.js ▓▓▓▓▓▓▓▓▓▓░░░░░░ 65.9% ( 844/1040)
Android node_modules/expo-router/entry.js ▓▓▓▓▓▓▓▓░░░░░░░░ 53.1% (664/911)
iOS node_modules/expo-router/entry.js ▓▓▓▓▓▓▓▓▓▓▓░░░░░ 71.5% ( 897/1062)
Android node_modules/expo-router/entry.js ▓▓▓▓▓▓▓▓▓▓░░░░░░ 66.8% ( 848/1039)
iOS node_modules/expo-router/entry.js ▓▓▓▓▓▓▓▓▓▓▓▓░░░░ 79.5% (1029/1154)
Android node_modules/expo-router/entry.js ▓▓▓▓▓▓▓▓▓▓▓▓░░░░ 79.6% (1001/1137)
iOS node_modules/expo-router/entry.js ▓▓▓▓▓▓▓▓▓▓▓▓▓░░░ 85.1% (1195/1411)
Android node_modules/expo-router/entry.js ▓▓▓▓▓▓▓▓▓▓▓▓▓░░░ 83.2% (1193/1400)
iOS node_modules/expo-router/entry.js ▓▓▓▓▓▓▓▓▓▓▓▓▓░░░ 85.1% (1455/1593)
Android node_modules/expo-router/entry.js ▓▓▓▓▓▓▓▓▓▓▓▓▓░░░ 83.2% (1386/1524)
iOS node_modules/expo-router/entry.js ▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░ 89.3% (1725/1835)
Android node_modules/expo-router/entry.js ▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░ 90.1% (1630/1815)
iOS Bundling failed 51807ms node_modules/expo-router/entry.js (1873 modules)
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.) was correctly copied to  before the user's last Save to GitHub action.
        3. As a last resort, inspect the network requests on the user's device (if possible) to see what URL the app is trying to fetch for the image. The 404 for  suggests an old, cached state is being rendered.
     - Why fix this issue and what will be achieved with the fix?: Visual elements are key to user experience. A missing image makes the feature look broken and unprofessional.
     - Status:  IN PROGRESS
     - Is recurring issue? Y
     - Should Test frontend/backend/both after fix?: frontend
     - Blocked on other issue: Potentially blocked by the user needing to clear their cache or a successful deployment.
  - Issue 4: 
     - Attempted fixes: None. This is a newly reported bug by the user.
     - Next debug checklist: 
        1. Locate the  endpoint for updating campaigns in .
        2. Review the logic. It likely re-runs the QR generation code unconditionally.
        3. Add a check: if  already exist for the campaign, do not regenerate them unless a specific flag (e.g., ) is passed in the payload. The update logic should only modify campaign metadata fields.
     - Why fix this issue and what will be achieved with the fix?: Prevents data loss and maintains consistency. If QR codes are printed and distributed, they cannot change every time an admin fixes a typo in the campaign name.
     - Status:  NOT STARTED
     - Is recurring issue? N
     - Should Test frontend/backend/both after fix?: backend
     - Blocked on other issue: None.

**In progress Task List**:
  - Task 1: **(P0) Fix User-Reported Critical Bugs**
     - Where to resume: Address the pending issues list above, starting with P0 priorities. The user is extremely frustrated, so focus on delivering a working fix for at least one of the major blockers (unclickable button or scan hanging).
     - What will be achieved with this?: Restore the user's confidence and make the core features of the app usable again.
     - Status: IN PROGRESS
     - Should Test frontend/backend/both after fix?: both
     - Blocked on something: User frustration. The agent must be precise and avoid introducing new regressions.

**Upcoming and Future Tasks**
- **(P1) Implement Real-time UI Update for Gimcana Scans**: After a user successfully scans a QR code in , the UI state should be updated immediately to reflect the new progress (e.g., 1 of 15 QRs scanned) and visually mark the scanned QR in the list. This was requested by the user in message 709.
- **(P2) Fix non-admin login issue in preview**: This was mentioned in the initial summary but never addressed.
- **(P3) Fix Promotion dates do not update on edit**: This is a known, long-standing bug from a previous session that has not been fixed. It needs investigation in .

**Completed work in this session**
- **Architectural Fix**: Migrated Gimcana campaign images from an ephemeral file path to a persistent Base64 string within the MongoDB document ( collection).
- **Bug Fix**: Corrected the frontend API service () to use the  environment variable, fixing local development 404 errors.
- **Bug Fix**: Fixed a bug where the Gimcana detail page would hang indefinitely for unauthenticated users.
- **Bug Fix**: Fixed a backend routing issue by creating a dedicated  endpoint to avoid conflicts with .
- **Regression Fix**: Restored the original OCR-based ticket scanning functionality in  after it was mistakenly replaced with a QR-only scanner.
- **UI/UX Refactor**: Replaced all instances of Offers with Promotions throughout the app interface and data-fetching logic.
- **UI/UX Refactor**: Improved the layout of the  screen to prevent action buttons from being pushed off-screen on smaller devices.
- **Backend Debugging**: Solved multiple backend issues related to incorrect database names ( vs ) and wrong API request formats (query params vs JSON body).

**Earlier issues found/mentioned but not fixed**
   - Issue 1: **Promotion dates do not update on edit.**
     - Debug checklist:
        1. Add logging to the  endpoint in  to see the received payload.
        2. Check the MongoDB update query to confirm it includes the date fields.
        3. Verify the frontend form submission sends the dates in the correct format.
     - Why to solve this issue and what will be achieved with this?: Core functionality for admins to manage promotions is broken.
     - Should Test frontend/backend/both after fix: both
     - Is recurring issue? Y
   - Issue 2: **Cannot log in as non-admin in preview.**
     - Debug checklist:
        1. Attempt to log in as a non-admin user in the web preview.
        2. Check the browser's developer console for errors during login or subsequent requests.
        3. Verify how the auth token is stored and used in  and , as there might be a web-specific issue with .
     - Why to solve this issue and what will be achieved with this?: Prevents proper testing of user-specific features and permissions.
     - Should Test frontend/backend/both after fix: frontend
     - Is recurring issue? Y

**Code Architecture**
yarn expo export

**Key Technical Concepts**
- **Ephemeral Filesystem:** This is the root cause of the missing image problem on production. Saving files to the local disk is not a viable strategy.
- **Base64 Image Storage:** The solution implemented for the Gimcana image was to store it as a Base64 data URI directly in the MongoDB document. This is a persistent solution.
- **Deployment Process:** **This is a CRITICAL point of failure.** Any frontend changes require a build step (yarn run v1.22.22
$ /app/frontend/node_modules/.bin/expo export
env: load .env.local .env.production .env
env: export EXPO_TUNNEL_SUBDOMAIN EXPO_PUBLIC_BACKEND_URL EXPO_PACKAGER_HOSTNAME EXPO_USE_FAST_RESOLVER METRO_CACHE_ROOT
Fast resolver is enabled.
Starting Metro Bundler
iOS Bundling failed 2191ms node_modules/expo-router/entry.js (1482 modules)
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command. in ) followed by copying the  directory to . This manual step was missed several times, causing the user to not see any of the applied fixes on production.
- **API Routing Precedence:** In FastAPI, more specific routes (like ) must be defined *before* more generic routes with path parameters (like ) to be matched correctly.
- **Web vs. Mobile Divergence:** The app has different behavior on web vs. mobile, especially for camera features.  is used to show fallback UIs. This logic might be a source of bugs if not handled carefully.

**key DB schema**
  - :  field now contains a Base64 data URI string, not a file path.
  - : Contains the generated QR codes for a campaign.
  - : Contains system-wide promotions.
  - : Legacy collection, now superseded by .
  - : Stores user entries for ticket-scanning raffles.

**All files of reference**
-   : **CRITICAL FILE.** Contains the ticket scanning logic. The user reports it hangs.
-   : **CRITICAL FILE.** Contains the Gimcana scanning logic. The user reports the Allow Camera button is unclickable.
-   : Contains the backend logic for Gimcanas. Needs to be checked for the QR code regeneration bug.
-   : Contains the main API routes, including the ticket processing OCR logic.

**Critical Info for New Agent**
-   **The user is extremely frustrated.** Your first priority is to acknowledge their frustration, be methodical, and deliver a working fix for at least one of their reported issues. Do not introduce new regressions.
-   **THE DEPLOYMENT PROCESS IS MANUAL AND FRAGILE.** To deploy frontend changes, you **MUST** run yarn run v1.22.22
$ /app/frontend/node_modules/.bin/expo export
env: load .env.local .env.production .env
env: export EXPO_TUNNEL_SUBDOMAIN EXPO_PUBLIC_BACKEND_URL EXPO_PACKAGER_HOSTNAME EXPO_USE_FAST_RESOLVER METRO_CACHE_ROOT
Fast resolver is enabled.
Starting Metro Bundler
iOS Bundling failed 1815ms node_modules/expo-router/entry.js (1188 modules)
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command. inside  and then copy the contents of  to . This has been the cause of most of the user's complaints that nothing has changed.
-   **The missing image issue is likely a CACHE or DEPLOYMENT problem.** The agent has confirmed the Base64 fix works locally. Guide the user to clear their app cache or perform a hard refresh after you are certain a new build has been deployed.
-   **Address the user's latest bug list from message 709 directly and in order of priority.** Do not get sidetracked.

**documents created in this job**
- None.

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (Msg 709):** Provided a clear, final list of 4 issues: 1) Ticket scanning not working, 2) Gimcana photo still missing, 3) Gimcana QRs regenerate on edit, 4) Gimcana UI doesn't update post-scan. **Status: NOT STARTED.**
2.  **User (Msg 696):** Clarified the full, original OCR-based functionality of the Scan Ticket screen. **Status: ADDRESSED (Agent confirmed backend logic is intact).**
3.  **User (Msg 683):** Asked to see the functionalities of the restored ticket scan page. **Status: ADDRESSED.**
4.  **User (Msg 668):** Reported that the ticket scanning feature (which was working before) is now broken. **Status: ADDRESSED (Agent restored the file from git).**
5.  **User (Msg 655):** Reported the Gimcana photo is still not showing. **Status: IN PROGRESS.**
6.  **User (Msg 642):** Reported the Gimcana scan gets stuck, and asked the agent to improve it all. **Status: IN PROGRESS.**
7.  **User (Msg 621):** Clarified that on the phone, the Gimcana camera *does* open but gets stuck processing after a successful scan. **Status: IN PROGRESS.**
8.  **User (Msg 600):** Reported the Allow Camera button fix didn't work and the photo is still missing. **Status: IN PROGRESS.**
9.  **User (Msg 587):** Argued that camera permissions are not the issue, as it works on one screen but not others. **Status: ADDRESSED (Agent acknowledged).**
10. **User (Msg 562):** Reported a cascade of bugs: scan hangs, Allow Camera button is unclickable, and photo is missing. **Status: IN PROGRESS.**

**Project Health Check:**
- Broken:
  - **Ticket Scanning:** The core OCR flow hangs or fails on mobile.
  - **Gimcana Scanning:** The camera permission button is unclickable, and when it does work, the scan hangs.
  - **Gimcana Image Display:** The main campaign image is not visible to the user on production, likely due to caching/deployment issues.
  - **Gimcana Admin Edit:** Editing a campaign incorrectly regenerates QR codes.
- Mocked:
  - None.

**3rd Party Integrations**
- **Railway:** Production hosting.
- **GitHub:** Source control and deployment trigger.
- **IONOS (SMTP):** Email sending.
- **Expo:** Framework and push notifications.
- **OpenAI GPT-4o-mini:** Used for OCR and data extraction in the ticket scanning process. Requires a user-provided API key.
- **reportlab:** Backend library for PDF generation.
- **expo-camera:** Frontend library for camera access.
- **expo-image-picker:** Frontend library for gallery access and taking photos.

**Testing status**
  - Testing agent used after significant changes: NO
  - Troubleshoot agent used after agent stuck in loop: NO
  - Test files created: []
  - Known regressions:
    - The ticket scanning functionality was completely broken by a refactor and then restored. Its current state on production is reported as non-functional by the user.

**Credentials to test flow:**
- Admin:  / 
- Test User:  / 

**What agent forgot to execute**
- The agent repeatedly failed to ensure the frontend build was completed and copied before telling the user to deploy, leading to massive user frustration.
- The agent did not fix the long-standing bugs from the initial handover (non-admin login fails, promotion dates do not update).
- The agent introduced a major regression by breaking the ticket scanning OCR flow, which it then had to spend time reverting.
- The agent got stuck in loops trying to fix the same issues (image not showing, camera not working) without addressing the root cause of deployment/caching.
</analysis>
